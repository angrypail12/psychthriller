<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychological Thriller Outline</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .firebase-status {
            font-size: 0.9em;
            color: #4ade80;
        }

        .firebase-status.error {
            color: #ef4444;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .title-section {
            margin-bottom: 20px;
        }

        .book-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border: none;
            border-bottom: 2px solid #ddd;
            width: 100%;
            background: none;
            outline: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .outline-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .outline-table th {
            background-color: #f8fafc;
            padding: 12px 8px;
            text-align: left;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 12px;
            position: relative;
        }

        .outline-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            vertical-align: top;
            min-height: 60px;
        }

        .scene-cell {
            background-color: #f1f5f9;
            font-weight: 600;
            min-width: 120px;
            position: relative;
        }

        .scene-cell:hover .scene-delete-btn {
            opacity: 1;
        }

        .scene-delete-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .data-cell {
            min-height: 80px;
            position: relative;
            background-color: white;
        }

        .text-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            background-color: #fafafa;
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 13px;
        }

        .item-content {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            resize: none;
            min-height: 20px;
            font-family: inherit;
            font-size: inherit;
        }

        .item-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .type-select {
            font-size: 11px;
            padding: 2px 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
        }

        .delete-item-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 11px;
        }

        .add-item-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            margin: 5px;
        }

        .add-item-btn:hover {
            background: #059669;
        }

        .header-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .header-btn {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
        }

        .count-row {
            background-color: #f1f5f9;
            font-weight: bold;
        }

        .count-cell {
            text-align: center;
            font-size: 14px;
            color: #374151;
        }

        /* Act styling */
        .act1 { border-left: 4px solid #10b981; }
        .act2 { border-left: 4px solid #f59e0b; }
        .act3 { border-left: 4px solid #ef4444; }

        /* Type border colors */
        .type-false-suspect { border-left: 4px solid #ff8800; }
        .type-misleading-motivation { border-left: 4px solid #ff6600; }
        .type-wrong-interpretation { border-left: 4px solid #ff4400; }
        .type-misleading-dialogue { border-left: 4px solid #ffaa44; }
        .type-coincidence { border-left: 4px solid #ffcc66; }
        .type-character-behavior { border-left: 4px solid #ff9944; }
        .type-major-revelation { border-left: 4px solid #ff4444; }
        .type-character-backstory { border-left: 4px solid #ff9999; }
        .type-relationship-truth { border-left: 4px solid #ffaaaa; }
        .type-small-mystery { border-left: 4px solid #ff7777; }
        .type-memory-error { border-left: 4px solid #8800ff; }
        .type-relationship-lie { border-left: 4px solid #9933ff; }
        .type-misperception { border-left: 4px solid #aa44ff; }
        .type-timeline-error { border-left: 4px solid #bb88ff; }
        .type-emotional-contradiction { border-left: 4px solid #ccaaff; }
        .type-detail-inconsistency { border-left: 4px solid #dd99ff; }

        /* Auth styles */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .auth-title {
            text-align: center;
            margin-bottom: 20px;
            color: #374151;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .auth-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .auth-message {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }

        .auth-error {
            color: #ef4444;
            text-align: center;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="authContainer" class="auth-container">
        <h2 class="auth-title">Psychological Thriller Outline</h2>
        <div id="loginForm" class="auth-form">
            <input type="email" id="emailInput" class="auth-input" placeholder="Email">
            <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
            <div class="auth-buttons">
                <button id="loginBtn" class="btn btn-primary" style="flex: 1;">Login</button>
                <button id="registerBtn" class="btn btn-secondary" style="flex: 1;">Register</button>
            </div>
            <div id="authError" class="auth-error"></div>
            <div class="auth-message">Login or register to save your thriller outline</div>
        </div>
    </div>

    <!-- Main App (Hidden until logged in) -->
    <div id="appContainer" class="hidden">
        <!-- Header -->
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userInitial">?</div>
                <div>
                    <div id="displayName">User</div>
                    <div class="firebase-status" id="firebaseStatus">Firebase: Connecting...</div>
                </div>
            </div>
            <button id="logoutBtn" class="btn btn-secondary">Logout</button>
        </div>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="loading hidden">
            Loading your outline...
        </div>

        <!-- Main Container -->
        <div class="container">
            <div class="title-section">
                <input type="text" class="book-title" id="bookTitle" placeholder="Your Psychological Thriller Title" value="Untitled Thriller">
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="addColumn()">Add Column</button>
                <button class="btn btn-primary" onclick="addScene()">Add Scene</button>
                <button class="btn btn-success" onclick="saveData()">Save Progress</button>
                <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import Data</button>
            </div>

            <table class="outline-table" id="outlineTable">
                <thead>
                    <tr>
                        <th>Scenes</th>
                        <th class="column-header">
                            Large Clues - Obvious (3-4 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Large Clues - Subtle (8-10 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Major Red Herrings/Misdirection (2-4 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Minor Misdirection (6-10 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Major Contradictions/Inconsistencies (5-8 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Minor inconsistencies (10-15 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Major Twist/Revelation (2-3 MAX)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Other minor/minor Revelations (8-12) (7 max)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ACT I -->
                    <tr class="act1">
                        <td class="scene-cell" contenteditable="true">
                            Scene 1 (Opening Image) - 6%
                            <button class="scene-delete-btn" onclick="deleteRow(this)">×</button>
                        </td>
                        <td class="data-cell" data-column="1">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="2">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="3">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="4">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="5">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="6">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="7">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="8">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                    </tr>
                    <tr class="act1">
                        <td class="scene-cell" contenteditable="true">
                            Scene 2 (Inciting Incident) - 16%
                            <button class="scene-delete-btn" onclick="deleteRow(this)">×</button>
                        </td>
                        <td class="data-cell" data-column="1">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="2">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="3">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="4">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="5">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="6">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="7">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="8">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                    </tr>
                    <tr class="act1">
                        <td class="scene-cell" contenteditable="true">
                            Scene 3 (Lock-In) - 25%
                            <button class="scene-delete-btn" onclick="deleteRow(this)">×</button>
                        </td>
                        <td class="data-cell" data-column="1">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="2">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="3">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="4">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="5">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="6">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="7">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                        <td class="data-cell" data-column="8">
                            <button class="add-item-btn" onclick="addTextItem(this)">+</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="controls">
                <p>Count totals will appear here automatically</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration - USING THE SAME AS YOUR JEDI PROJECT
        const firebaseConfig = {
            apiKey: "AIzaSyCsP9DDFsCCjC-1EpA8uzeRhWUfFrQ8-Zo",
            authDomain: "jedi-8ce49.firebaseapp.com",
            databaseURL: "https://jedi-8ce49-default-rtdb.firebaseio.com/",
            projectId: "jedi-8ce49",
            storageBucket: "jedi-8ce49.firebasestorage.app",
            messagingSenderId: "1001546846157",
            appId: "1:1001546846157:web:328f6ef11b9e32fbe7be84"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Global variables
        let currentUser = null;
        let outlineData = {
            title: 'Untitled Thriller',
            scenes: [],
            columns: []
        };

        // DOM elements
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const authError = document.getElementById('authError');
        const firebaseStatus = document.getElementById('firebaseStatus');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Authentication functions
        function login() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                authError.textContent = 'Please enter both email and password';
                return;
            }

            showLoading();
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(() => {
                    authError.textContent = '';
                    emailInput.value = '';
                    passwordInput.value = '';
                })
                .catch(error => {
                    authError.textContent = error.message;
                    hideLoading();
                });
        }

        function register() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                authError.textContent = 'Please enter both email and password';
                return;
            }

            if (password.length < 6) {
                authError.textContent = 'Password must be at least 6 characters';
                return;
            }

            showLoading();
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then(() => {
                    authError.textContent = '';
                    emailInput.value = '';
                    passwordInput.value = '';
                })
                .catch(error => {
                    authError.textContent = error.message;
                    hideLoading();
                });
        }

        function logout() {
            firebase.auth().signOut();
        }

        // UI functions
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function showApp() {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            firebaseStatus.textContent = 'Firebase: Connected';
            firebaseStatus.classList.remove('error');
        }

        function showAuth() {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            firebaseStatus.textContent = 'Firebase: Disconnected';
            firebaseStatus.classList.add('error');
        }

        // Data functions
        function saveData() {
            if (!currentUser) return;

            const data = {
                title: document.getElementById('bookTitle').value,
                table: document.getElementById('outlineTable').outerHTML,
                lastUpdated: new Date().toISOString()
            };

            // Save under a different path than your Jedi project
            firebase.database().ref(`thriller-outlines/${currentUser.uid}`).set(data)
                .then(() => {
                    firebaseStatus.textContent = 'Firebase: Saved';
                    setTimeout(() => {
                        firebaseStatus.textContent = 'Firebase: Connected';
                    }, 2000);
                })
                .catch(error => {
                    console.error('Save error:', error);
                    firebaseStatus.textContent = 'Firebase: Error saving';
                    firebaseStatus.classList.add('error');
                });
        }

        function loadData() {
            if (!currentUser) return;

            showLoading();
            firebase.database().ref(`thriller-outlines/${currentUser.uid}`).once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        document.getElementById('bookTitle').value = data.title || 'Untitled Thriller';
                        if (data.table) {
                            document.getElementById('outlineTable').outerHTML = data.table;
                            setupTableEventListeners();
                        }
                        firebaseStatus.textContent = 'Firebase: Data loaded';
                    } else {
                        firebaseStatus.textContent = 'Firebase: No data found';
                    }
                    hideLoading();
                })
                .catch(error => {
                    console.error('Load error:', error);
                    firebaseStatus.textContent = 'Firebase: Error loading';
                    firebaseStatus.classList.add('error');
                    hideLoading();
                });
        }

        function exportData() {
            const data = {
                title: document.getElementById('bookTitle').value,
                table: document.getElementById('outlineTable').outerHTML,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'thriller-outline-' + new Date().toISOString().slice(0,10) + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    document.getElementById('bookTitle').value = data.title || 'Imported Thriller';
                    if (data.table) {
                        document.getElementById('outlineTable').outerHTML = data.table;
                        setupTableEventListeners();
                        saveData(); // Auto-save after import
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Table manipulation functions
        function addTextItem(button) {
            const cell = button.parentNode;
            const columnIndex = parseInt(cell.dataset.column);
            const textItem = document.createElement('div');
            textItem.className = 'text-item';

            let options = [];
            switch (columnIndex) {
                case 3: // Major Red Herrings/Misdirection
                    options = [
                        { value: 'false-suspect', text: 'False Suspect' },
                        { value: 'misleading-motivation', text: 'Misleading Motivation' },
                        { value: 'wrong-interpretation', text: 'Wrong Interpretation of Evidence' }
                    ];
                    break;
                case 4: // Minor Misdirection
                    options = [
                        { value: 'misleading-dialogue', text: 'Misleading Dialogue' },
                        { value: 'coincidence', text: 'Coincidence that Suggests Wrong Conclusion' },
                        { value: 'character-behavior', text: 'Character Behavior that Implies False Things' }
                    ];
                    break;
                case 5: // Major Contradictions/Inconsistencies
                    options = [
                        { value: 'memory-error', text: 'Memory "Error" about Key Events' },
                        { value: 'relationship-lie', text: 'Lie about Relationships/Past' },
                        { value: 'misperception', text: 'Misperception about Current Events' }
                    ];
                    break;
                case 6: // Minor Inconsistencies
                    options = [
                        { value: 'timeline-error', text: 'Small Timeline Error' },
                        { value: 'emotional-contradiction', text: 'Emotional Contradiction' },
                        { value: 'detail-inconsistency', text: 'Details that Don\'t Add Up' }
                    ];
                    break;
                case 7: // Major Twist/Revelation
                    options = [
                        { value: 'major-revelation', text: 'Major Twist/Revelation' }
                    ];
                    break;
                case 8: // Minor Revelations/Other Information
                    options = [
                        { value: 'character-backstory', text: 'Character Backstory Reveal' },
                        { value: 'relationship-truth', text: 'Relationship Truth' },
                        { value: 'small-mystery', text: 'Small Mystery Solution' }
                    ];
                    break;
                default:
                    options = [{ value: 'general', text: 'General' }];
            }

            if (options.length > 1) {
                textItem.innerHTML = `
                    <textarea class="item-content" placeholder="Enter your item..."></textarea>
                    <div class="item-controls">
                        <select class="type-select" onchange="updateItemType(this)">
                            ${options.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                        </select>
                        <button class="delete-item-btn" onclick="deleteTextItem(this)">×</button>
                    </div>
                `;
            } else {
                textItem.innerHTML = `
                    <textarea class="item-content" placeholder="Enter your item..."></textarea>
                    <div class="item-controls">
                        <button class="delete-item-btn" onclick="deleteTextItem(this)">×</button>
                    </div>
                `;
            }

            cell.insertBefore(textItem, button);
            updateAllCounts();

            // Auto-save after adding item
            setTimeout(saveData, 500);
        }

        function deleteTextItem(button) {
            const textItem = button.closest('.text-item');
            textItem.remove();
            updateAllCounts();
            
            // Auto-save after deleting item
            setTimeout(saveData, 500);
        }

        function updateItemType(select) {
            const textItem = select.closest('.text-item');
            
            // Remove all type classes
            const typeClasses = [
                'type-false-suspect', 'type-misleading-motivation', 'type-wrong-interpretation',
                'type-misleading-dialogue', 'type-coincidence', 'type-character-behavior',
                'type-major-revelation', 'type-character-backstory', 'type-relationship-truth',
                'type-small-mystery', 'type-memory-error', 'type-relationship-lie',
                'type-misperception', 'type-timeline-error', 'type-emotional-contradiction',
                'type-detail-inconsistency'
            ];
            
            typeClasses.forEach(cls => textItem.classList.remove(cls));
            
            // Add new type class
            textItem.classList.add('type-' + select.value);
            
            // Auto-save after type change
            setTimeout(saveData, 500);
        }

        function addColumn() {
            const table = document.getElementById('outlineTable');
            const headerRow = table.querySelector('thead tr');
            const bodyRows = table.querySelectorAll('tbody tr');
            
            // Add header
            const newHeader = document.createElement('th');
            newHeader.className = 'column-header';
            newHeader.innerHTML = `
                New Column
                <div class="header-controls">
                    <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                    <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                </div>
            `;
            headerRow.appendChild(newHeader);
            
            // Add cells to existing rows
            const newColumnIndex = headerRow.children.length - 1;
            bodyRows.forEach(row => {
                const newCell = document.createElement('td');
                newCell.className = 'data-cell';
                newCell.setAttribute('data-column', newColumnIndex);
                newCell.innerHTML = '<button class="add-item-btn" onclick="addTextItem(this)">+</button>';
                row.appendChild(newCell);
            });
            
            // Auto-save after adding column
            setTimeout(saveData, 500);
        }

        function deleteColumn(button) {
            if (!confirm('Are you sure you want to delete this column?')) return;
            
            const header = button.closest('th');
            const columnIndex = Array.from(header.parentNode.children).indexOf(header);
            
            if (columnIndex === 0) {
                alert('Cannot delete the scenes column');
                return;
            }
            
            // Remove header
            header.remove();
            
            // Remove corresponding cells
            const table = document.getElementById('outlineTable');
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                if (row.children[columnIndex]) {
                    row.children[columnIndex].remove();
                }
            });
            
            updateAllCounts();
            
            // Auto-save after deleting column
            setTimeout(saveData, 500);
        }

        function addScene() {
            const table = document.getElementById('outlineTable').querySelector('tbody');
            const columnCount = document.querySelectorAll('thead th').length;
            const sceneCount = table.querySelectorAll('tr').length + 1;
            
            const newRow = document.createElement('tr');
            newRow.className = 'act2'; // Default to act 2
            
            // Scene cell
            const sceneCell = document.createElement('td');
            sceneCell.className = 'scene-cell';
            sceneCell.contentEditable = true;
            sceneCell.innerHTML = `
                Scene ${sceneCount} - New Scene
                <button class="scene-delete-btn" onclick="deleteRow(this)">×</button>
            `;
            newRow.appendChild(sceneCell);
            
            // Data cells
            for (let i = 1; i < columnCount; i++) {
                const dataCell = document.createElement('td');
                dataCell.className = 'data-cell';
                dataCell.setAttribute('data-column', i);
                dataCell.innerHTML = '<button class="add-item-btn" onclick="addTextItem(this)">+</button>';
                newRow.appendChild(dataCell);
            }
            
            table.appendChild(newRow);
            
            // Auto-save after adding scene
            setTimeout(saveData, 500);
        }

        function deleteRow(button) {
            if (!confirm('Are you sure you want to delete this scene?')) return;
            
            const row = button.closest('tr');
            row.remove();
            updateAllCounts();
            
            // Auto-save after deleting scene
            setTimeout(saveData, 500);
        }

        function editColumnHeader(button) {
            const header = button.closest('th');
            const currentText = header.firstChild.textContent.trim();
            const newText = prompt('Edit column header:', currentText);
            
            if (newText && newText !== currentText) {
                header.firstChild.textContent = newText;
                
                // Auto-save after editing header
                setTimeout(saveData, 500);
            }
        }

        function updateAllCounts() {
            const table = document.getElementById('outlineTable');
            const headers = table.querySelectorAll('thead th');
            
            // Remove existing count row
            const existingCountRow = table.querySelector('.count-row');
            if (existingCountRow) {
                existingCountRow.remove();
            }
            
            // Create new count row
            const countRow = document.createElement('tr');
            countRow.className = 'count-row';
            
            headers.forEach((header, index) => {
                const countCell = document.createElement('td');
                countCell.className = 'count-cell';
                
                if (index === 0) {
                    countCell.textContent = 'TOTALS:';
                } else {
                    const columnCells = table.querySelectorAll(`td[data-column="${index}"]`);
                    let count = 0;
                    
                    columnCells.forEach(cell => {
                        count += cell.querySelectorAll('.text-item').length;
                    });
                    
                    countCell.textContent = count;
                }
                
                countRow.appendChild(countCell);
            });
            
            table.querySelector('tbody').appendChild(countRow);
        }

        function setupTableEventListeners() {
            // Add auto-save on content changes
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('item-content') || 
                    e.target.id === 'bookTitle' || 
                    e.target.classList.contains('scene-cell')) {
                    
                    // Debounced auto-save
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(saveData, 1000);
                }
            });
            
            updateAllCounts();
        }

        // Auth state listener
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('userInitial').textContent = user.email.charAt(0).toUpperCase();
                document.getElementById('displayName').textContent = user.email;
                showApp();
                loadData();
            } else {
                currentUser = null;
                showAuth();
                hideLoading();
            }
        });

        // Event listeners
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Enter key listeners for auth
        emailInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });
        passwordInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupTableEventListeners();
            
            // Auto-save every 30 seconds if logged in
            setInterval(() => {
                if (currentUser) {
                    saveData();
                }
            }, 30000);
        });
    </script>
</body>
</html>
