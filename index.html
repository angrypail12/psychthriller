<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychological Thriller Outline</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .firebase-status {
            font-size: 0.9em;
            color: #4ade80;
        }

        .firebase-status.error {
            color: #ef4444;
        }

        .container {
    max-width: none; /* Remove the 1400px constraint */
    width: 100vw; /* Use full viewport width */
    margin: 0;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 20px;
    box-sizing: border-box;
    overflow-x: auto; /* Allow horizontal scrolling if needed */
}

/* Add a wrapper for the table to handle overflow better */
.table-wrapper {
    overflow-x: auto;
    margin-bottom: 20px;
}

        .title-section {
            margin-bottom: 20px;
        }

        .book-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border: none;
            border-bottom: 2px solid #ddd;
            width: 100%;
            background: none;
            outline: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .outline-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 13px;
        }

        /* Combined header styling */
.outline-table th {
    background-color: #f8fafc;
    padding: 12px 8px;
    text-align: left;
    border: 1px solid #e2e8f0;
    font-weight: 600;
    font-size: 12px;
    white-space: normal;
    word-wrap: break-word;
    vertical-align: top;
    line-height: 1.2;
    /* Remove position: relative to allow sticky positioning */
}

        .outline-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            vertical-align: top;
            min-height: 60px;
        }

        .scene-cell {
            background-color: #f1f5f9;
            font-weight: 600;
            min-width: 120px;
            position: relative;
        }

        .scene-cell:hover .scene-delete-btn {
            opacity: 1;
        }

        .scene-delete-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .item-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 20px;
    width: 100%; /* Take full width */
    box-sizing: border-box; /* Include padding in width */
}

        .type-select {
    font-size: 11px;
    padding: 2px 4px;
    border: 1px solid #ddd;
    border-radius: 3px;
    background: white;
    max-width: 120px; /* Limit dropdown width */
    overflow: hidden; /* Hide overflow text */
    text-overflow: ellipsis; /* Show ... for long text */
    white-space: nowrap; /* Keep text on one line */
}

        .delete-item-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 11px;
            position: relative; /* Add this */
            z-index: 1; /* Add this */
            flex-shrink: 0; /* Prevent button from shrinking */
        }

        .add-item-btn:hover {
            background: #059669;
        }

        .header-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .header-btn {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
        }

.outline-table thead th {
    background-color: #f8fafc !important;
    padding: 12px 8px;
    text-align: left;
    border: 1px solid #e2e8f0;
    font-weight: 600;
    font-size: 12px;
    position: sticky !important;
    top: 0 !important;
    z-index: 100 !important;
}

.outline-table tbody td:first-child {
    position: sticky;
    left: 0;
    background-color: #f1f5f9;
    z-index: 5;
}

.outline-table thead th:first-child {
    position: sticky;
    left: 0;
    z-index: 15;
    background-color: #f8fafc;
}

/* Act summary styling */
.act-summary-cell {
    background-color: #e0f2fe !important;
    border-left: 4px solid #0369a1;
    padding: 10px 8px;
    text-align: center;
    font-size: 11px;
    font-weight: 600;
    vertical-align: middle;
}

        /* Make data columns equal width */
.outline-table th:nth-child(n+3),
.outline-table td:nth-child(n+3) {
    width: 12.5%; /* 8 columns = 100% / 8 = 12.5% each */
    min-width: 150px; /* Minimum width to ensure readability */
    max-width: 200px; /* Maximum width to prevent excessive expansion */
}

/* Ensure the scenes and act summary columns stay their current size */
.outline-table th:nth-child(1),
.outline-table td:nth-child(1) {
    width: 100px;
    min-width: 100px;
}

.outline-table th:nth-child(2),
.outline-table td:nth-child(2) {
    width: 80px;
    min-width: 80px;
}

     /* Fix data cell backgrounds - remove blue background */
.data-cell {
    min-height: 80px;
    position: relative;
    background-color: white !important;
    overflow: hidden; /* Prevent content from spilling into other cells */
    box-sizing: border-box;
}

/* Right-align add buttons */
.add-item-btn {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 12px;
    margin: 5px;
    float: right; /* Right-align the buttons */
}

      /* Make text areas auto-resize to content */
.item-content {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    resize: none;
    min-height: 40px;
    max-height: 120px;
    font-family: inherit;
    font-size: inherit;
    line-height: 1.4;
    word-wrap: break-word;
    box-sizing: border-box;
    width: 100%;
    overflow-y: auto;
    overflow-x: hidden;
}

/* Ensure text items expand to fit content */
.text-item {
    margin-bottom: 8px;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    background-color: #fafafa;
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 13px;
    min-height: auto; /* Remove fixed height constraint */
    width: 100%; /* Ensure it takes full width of cell */
    box-sizing: border-box; /* Include padding in width calculation */
    overflow: hidden; /* Prevent overflow into neighboring cells */
}

.act1-summary { border-left-color: #10b981; background-color: #d1fae5 !important; }
.act2-summary { border-left-color: #f59e0b; background-color: #fef3c7 !important; }
.act3-summary { border-left-color: #ef4444; background-color: #fee2e2 !important; }

        .count-row {
            background-color: #f1f5f9;
            font-weight: bold;
        }

        .count-cell {
            text-align: center;
            font-size: 14px;
            color: #374151;
        }

        /* Act styling */
        .act1 { border-left: 4px solid #10b981; }
        .act2 { border-left: 4px solid #f59e0b; }
        .act3 { border-left: 4px solid #ef4444; }

        /* Type border colors */
        .type-false-suspect { border-left: 4px solid #ff8800; }
        .type-misleading-motivation { border-left: 4px solid #ff6600; }
        .type-wrong-interpretation { border-left: 4px solid #ff4400; }
        .type-misleading-dialogue { border-left: 4px solid #ffaa44; }
        .type-coincidence { border-left: 4px solid #ffcc66; }
        .type-character-behavior { border-left: 4px solid #ff9944; }
        .type-major-revelation { border-left: 4px solid #ff4444; }
        .type-character-backstory { border-left: 4px solid #ff9999; }
        .type-relationship-truth { border-left: 4px solid #ffaaaa; }
        .type-small-mystery { border-left: 4px solid #ff7777; }
        .type-memory-error { border-left: 4px solid #8800ff; }
        .type-relationship-lie { border-left: 4px solid #9933ff; }
        .type-misperception { border-left: 4px solid #aa44ff; }
        .type-timeline-error { border-left: 4px solid #bb88ff; }
        .type-emotional-contradiction { border-left: 4px solid #ccaaff; }
        .type-detail-inconsistency { border-left: 4px solid #dd99ff; }

        /* Auth styles */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .auth-title {
            text-align: center;
            margin-bottom: 20px;
            color: #374151;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .auth-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .auth-message {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }

        .auth-error {
            color: #ef4444;
            text-align: center;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .hidden {
            display: none;
        }

        /* Debug section */
        .debug-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #1a202c;
            border-radius: 8px;
            color: #e2e8f0;
        }

        .debug-log {
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background-color: #2d3748;
            border-radius: 4px;
            margin-top: 10px;
        }

     /* Title ideas section */
.title-ideas-section {
    margin-top: 20px;
    padding: 20px;
    background-color: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.title-ideas-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.title-ideas-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}

.title-idea-item {
    background: white;
    padding: 12px;
    border-radius: 4px;
    border: 1px solid #d1d5db;
    position: relative;
    display: flex;
    align-items: center;
    cursor: move;
    transition: all 0.2s ease;
}

.title-idea-item:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-color: #3b82f6;
}

.title-idea-item.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
}

.title-rank {
    background: #3b82f6;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    margin-right: 10px;
    flex-shrink: 0;
}

.title-idea-text {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    font-size: 14px;
    padding: 5px;
}

.drag-handle {
    margin-right: 8px;
    color: #6b7280;
    cursor: grab;
    font-size: 16px;
}

.drag-handle:active {
    cursor: grabbing;
}

.delete-title-btn {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 3px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 5px;
}

.add-title-btn {
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 14px;
}

.add-title-btn:hover {
    background: #2563eb;
}

.drop-indicator {
    height: 2px;
    background: #3b82f6;
    margin: 5px 0;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.drop-indicator.active {
    opacity: 1;
}
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="authContainer" class="auth-container">
        <h2 class="auth-title">Psychological Thriller Outline</h2>
        <div id="loginForm" class="auth-form">
            <input type="email" id="emailInput" class="auth-input" placeholder="Email">
            <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
            <div class="auth-buttons">
                <button id="loginBtn" class="btn btn-primary" style="flex: 1;">Login</button>
                <button id="registerBtn" class="btn btn-secondary" style="flex: 1;">Register</button>
            </div>
            <div id="authError" class="auth-error"></div>
            <div class="auth-message">Login or register to save your thriller outline</div>
        </div>
    </div>

    <!-- Main App (Hidden until logged in) -->
    <div id="appContainer" class="hidden">
        <!-- Header -->
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="userInitial">?</div>
                <div>
                    <div id="displayName">User</div>
                    <div class="firebase-status" id="firebaseStatus">Firebase: Connecting...</div>
                </div>
            </div>
            <button id="logoutBtn" class="btn btn-secondary">Logout</button>
        </div>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="loading hidden">
            Loading your outline...
        </div>

        <!-- Main Container -->
        <div class="container">
            <div class="title-section">
                <input type="text" class="book-title" id="bookTitle" placeholder="Your Psychological Thriller Title" value="Untitled Thriller">
            </div>

            <div class="controls">
    <button class="btn btn-primary" onclick="addColumn()">Add Column</button>
    <button class="btn btn-primary" onclick="addScene()">Add Scene</button>
    <button class="btn btn-primary" onclick="forceSave()">Save Now</button> 
    <button class="btn btn-secondary" onclick="exportDataToText()">Backup to Text</button>
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import Data</button>
</div>

<div class="table-wrapper">
    <table class="outline-table" id="outlineTable">
        <thead>
            <tr>
                <th>Scenes</th>
                <th class="act-summary-header">Act Summary</th>
                        <th class="column-header">
                            Legit Clues - Obvious (4-5 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Legit Clues - Subtle (8-10 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Major Red Herrings/Misdirection (2-3 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Minor Misdirection (6-10 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Major Contradictions/Inconsistencies (5-8 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Minor inconsistencies (10-15 total)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Major Twist/Revelation (2-3 MAX)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                        <th class="column-header">
                            Other minor/minor Revelations (8-12) (7 max)
                            <div class="header-controls">
                                <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                                <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                            </div>
                        </th>
                    </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<div class="controls">
    <p>Count totals will appear here automatically</p>
</div>
        </div>

<!-- Title Ideas Section -->
        <div class="title-ideas-section">
            <div class="title-ideas-header">
                <h3>Title Ideas (Drag to Reorder)</h3>
                <button class="add-title-btn" onclick="addTitleIdea()">Add Title</button>
            </div>
            <div class="title-ideas-list" id="titleIdeasList">
                <!-- Title ideas will be added here -->
            </div>
        </div>
        
        <!-- Debug Section -->
        <div class="debug-section">
            <h3>Debug Log</h3>
            <div class="debug-log" id="debugLog">Firebase and app debug info will appear here...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
    apiKey: "AIzaSyD74wPC0oyB8jnS3rPgkfa6szzyBPLrbfg",
    authDomain: "thriller-table.firebaseapp.com",
    databaseURL: "https://thriller-table-default-rtdb.firebaseio.com",
    projectId: "thriller-table",
    storageBucket: "thriller-table.firebasestorage.app",
    messagingSenderId: "737792309009",
    appId: "1:737792309009:web:fa0238f531befc33143eb0"
};

        // Global variables
        let currentUser = null;
        let autoSaveTimeout = null;

        // DOM elements
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const authError = document.getElementById('authError');
        const firebaseStatus = document.getElementById('firebaseStatus');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const debugLog = document.getElementById('debugLog');

        // Debug logging function
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            if (debugLog) {
                debugLog.textContent += logMessage + '\n';
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            logDebug('Firebase initialized successfully');
            firebaseStatus.textContent = 'Firebase: Initialized';
        } catch (error) {
            logDebug('Firebase initialization error: ' + error.message);
            firebaseStatus.textContent = 'Firebase: Init Error';
            firebaseStatus.classList.add('error');
        }

        // Authentication functions
        function login() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                authError.textContent = 'Please enter both email and password';
                return;
            }

            logDebug('Attempting login for: ' + email);
            showLoading();
            
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(() => {
                    authError.textContent = '';
                    emailInput.value = '';
                    passwordInput.value = '';
                    logDebug('Login successful');
                })
                .catch(error => {
                    authError.textContent = error.message;
                    logDebug('Login error: ' + error.message);
                    hideLoading();
                });
        }

        function register() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                authError.textContent = 'Please enter both email and password';
                return;
            }

            if (password.length < 6) {
                authError.textContent = 'Password must be at least 6 characters';
                return;
            }

            logDebug('Attempting registration for: ' + email);
            showLoading();
            
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then(() => {
                    authError.textContent = '';
                    emailInput.value = '';
                    passwordInput.value = '';
                    logDebug('Registration successful');
                })
                .catch(error => {
                    authError.textContent = error.message;
                    logDebug('Registration error: ' + error.message);
                    hideLoading();
                });
        }

        function logout() {
            logDebug('Logging out');
            firebase.auth().signOut();
        }

        // UI functions
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function showApp() {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            firebaseStatus.textContent = 'Firebase: Connected';
            firebaseStatus.classList.remove('error');
        }

        function showAuth() {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            firebaseStatus.textContent = 'Firebase: Disconnected';
            firebaseStatus.classList.add('error');
        }

        // Auto-save with debouncing
        function scheduleAutoSave() {
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            autoSaveTimeout = setTimeout(() => {
                if (currentUser) {
                    saveData();
                }
            }, 1000);
        }

        // Data functions
        function saveData() {
    if (!currentUser) {
        logDebug('Cannot save - no user logged in');
        return;
    }

    try {
        logDebug('Starting data save for user: ' + currentUser.uid);
        const tableData = extractTableData();
        
        if (!tableData.rows || tableData.rows.length === 0) {
            logDebug('WARNING: No table data to save!');
            return;
        }
        
        const data = {
            title: document.getElementById('bookTitle').value || 'Untitled Thriller',
            tableData: tableData,
            lastUpdated: new Date().toISOString(),
            userEmail: currentUser.email // Add for verification
        };

        logDebug('Extracted data - rows: ' + tableData.rows.length + ', title: ' + data.title);
        logDebug('Full extracted data: ' + JSON.stringify(tableData, null, 2));

        firebase.database().ref(`thriller-outlines/${currentUser.uid}`).set(data)
            .then(() => {
                firebaseStatus.textContent = 'Firebase: Saved ✓';
                firebaseStatus.classList.remove('error');
                logDebug('Data saved successfully at: ' + new Date().toISOString());
                
                // Verify the save by reading it back
                return firebase.database().ref(`thriller-outlines/${currentUser.uid}`).once('value');
            })
            .then(snapshot => {
                const savedData = snapshot.val();
                if (savedData && savedData.tableData && savedData.tableData.rows.length > 0) {
                    logDebug('Verification: Data properly saved with ' + savedData.tableData.rows.length + ' rows');
                } else {
                    logDebug('ERROR: Verification failed - data not properly saved!');
                }
                
                setTimeout(() => {
                    if (firebaseStatus.textContent === 'Firebase: Saved ✓') {
                        firebaseStatus.textContent = 'Firebase: Connected';
                    }
                }, 2000);
            })
            .catch(error => {
                logDebug('Save error: ' + error.message);
                firebaseStatus.textContent = 'Firebase: Save Error';
                firebaseStatus.classList.add('error');
            });
    } catch (error) {
        logDebug('Data extraction error: ' + error.message);
        firebaseStatus.textContent = 'Firebase: Data Error';
        firebaseStatus.classList.add('error');
    }
}

        function extractTableData() {
    const table = document.getElementById('outlineTable');
    const rows = table.querySelectorAll('tbody tr:not(.count-row)');
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => {
        const text = th.childNodes[0] ? th.childNodes[0].textContent : th.textContent;
        return text.trim();
    });

    const extractedData = {
        headers: headers,
        rows: []
    };

    rows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td');
        const sceneCell = cells[0];
        const sceneText = sceneCell.childNodes[0] ? sceneCell.childNodes[0].textContent.trim() : sceneCell.textContent.trim();
        
        const rowData = {
            scene: sceneText,
            actClass: row.className,
            columns: []
        };

        // Process ONLY data cells - skip scenes (index 0) and any act summary cells
        // Look for cells with data-column attribute starting from 2
        const dataCells = row.querySelectorAll('td[data-column]');
        
        dataCells.forEach(cell => {
            const columnIndex = parseInt(cell.getAttribute('data-column'));
            
            // Only process data columns (2 and above)
            if (columnIndex >= 2) {
                const textItems = cell.querySelectorAll('.text-item');
                const columnData = [];

                textItems.forEach(item => {
                    const contentEl = item.querySelector('.item-content');
                    const typeSelect = item.querySelector('.type-select');
                    
                    const content = contentEl ? (contentEl.value || contentEl.textContent || '') : '';
                    const type = typeSelect ? typeSelect.value : '';
                    
                    if (content.trim()) {
                        columnData.push({
                            content: content.trim(),
                            type: type
                        });
                    }
                });

                // Make sure we have the right index in the columns array
                const arrayIndex = columnIndex - 2; // Convert column index to array index
                
                // Ensure the array is long enough
                while (rowData.columns.length <= arrayIndex) {
                    rowData.columns.push([]);
                }
                
                rowData.columns[arrayIndex] = columnData;
            }
        });

        logDebug(`Extracting row ${rowIndex}: ${sceneText}, found ${rowData.columns.length} data columns`);
        logDebug(`Row ${rowIndex} column data: ${JSON.stringify(rowData.columns)}`);
        extractedData.rows.push(rowData);
    });

    return extractedData;
}

        function loadData() {
    if (!currentUser) return;

    logDebug('Loading data for user: ' + currentUser.uid + ' (' + currentUser.email + ')');
    showLoading();
    
    firebase.database().ref(`thriller-outlines/${currentUser.uid}`).once('value')
        .then(snapshot => {
            const data = snapshot.val();
            if (data) {
                logDebug('Data found - last updated: ' + (data.lastUpdated || 'unknown'));
                logDebug('Data contains ' + (data.tableData?.rows?.length || 0) + ' rows');
                
                // Set title
document.getElementById('bookTitle').value = data.title || 'Untitled Thriller';

// Load title ideas separately (they're stored in a different Firebase location)
firebase.database().ref(`thriller-outlines/${currentUser.uid}/titleIdeas`).once('value')
    .then(snapshot => {
        const titleIdeas = snapshot.val();
        loadTitleIdeas(titleIdeas);
    })
    .catch(error => {
        logDebug('Error loading title ideas: ' + error.message);
        loadTitleIdeas([]); // Load empty if error
    });
                
                // Load table data
                if (data.tableData && data.tableData.rows && data.tableData.rows.length > 0) {
                    rebuildTableFromData(data.tableData);
                    logDebug('Table rebuilt from structured data successfully');
                } else {
                    logDebug('No valid structured data found - using default table');
                    rebuildDefaultTable();
                }
                
                firebaseStatus.textContent = 'Firebase: Data Loaded';
                firebaseStatus.classList.remove('error');
            } else {
                logDebug('No data found for user - creating default table');
                rebuildDefaultTable();
                firebaseStatus.textContent = 'Firebase: No Data';
                firebaseStatus.classList.remove('error');
            }
            hideLoading();
        })
        .catch(error => {
            logDebug('Load error: ' + error.message);
            firebaseStatus.textContent = 'Firebase: Load Error';
            firebaseStatus.classList.add('error');
            hideLoading();
            
            // Fallback to default table
            rebuildDefaultTable();
        });
}

        function ensureFullTable() {
    // Make sure we have all 9 scenes visible
    const tbody = document.querySelector('#outlineTable tbody');
    const existingRows = tbody.querySelectorAll('tr:not(.count-row)');
    
    logDebug('Current table has ' + existingRows.length + ' scene rows');
    
    // If we don't have all 9 scenes, the table got corrupted somehow
    // Let's rebuild it from scratch
    if (existingRows.length !== 9) {
        logDebug('Table corrupted - rebuilding all 9 scenes');
        rebuildDefaultTable();
    }
    
    setupTableEventListeners();
    updateAllCounts();
}

function rebuildDefaultTable() {
    const tbody = document.querySelector('#outlineTable tbody');
    tbody.innerHTML = '';

    const defaultScenes = [
        { name: 'Scene 1 (Opening Image) - 6%', class: 'act1' },
        { name: 'Scene 2 (Inciting Incident) - 16%', class: 'act1' },
        { name: 'Scene 3 (Lock-In) - 25%', class: 'act1' },
        { name: 'Scene 4 (First Encounters) - 37%', class: 'act2' },
        { name: 'Scene 5 (Midpoint Revelation) - 50%', class: 'act2' },
        { name: 'Scene 6 (Things Get Worse) - 75%', class: 'act2' },
        { name: 'Scene 7 (Final Confrontation) - 87%', class: 'act3' },
        { name: 'Scene 8 (Resolution of the Sin) - 93%', class: 'act3' },
        { name: 'Scene 9 (New Equilibrium) - 100%', class: 'act3' }
    ];

    const columnCount = document.querySelectorAll('#outlineTable thead th').length;

    defaultScenes.forEach((scene, index) => {
        const row = document.createElement('tr');
        row.className = scene.class;

        // Scene cell
        const sceneCell = document.createElement('td');
        sceneCell.className = 'scene-cell';
        sceneCell.contentEditable = true;
        sceneCell.innerHTML = `${scene.name}<button class="scene-delete-btn" onclick="deleteRow(this)">×</button>`;
        row.appendChild(sceneCell);

        // Act summary cell (merged cells)
        const actSummaryCell = document.createElement('td');
        if (index === 0) { // Act 1 - first scene
            actSummaryCell.className = 'act-summary-cell act1-summary';
            actSummaryCell.rowSpan = 3;
            actSummaryCell.innerHTML = 'ACT I<br>4-5 clues<br>(To establish mystery)<br><span id="act1-count">0</span> added';
        } else if (index === 3) { // Act 2 - first scene
            actSummaryCell.className = 'act-summary-cell act2-summary';
            actSummaryCell.rowSpan = 3;
            actSummaryCell.innerHTML = 'ACT II<br>7-10 clues<br>(To build complexity)<br><span id="act2-count">0</span> added';
        } else if (index === 6) { // Act 3 - first scene
            actSummaryCell.className = 'act-summary-cell act3-summary';
            actSummaryCell.rowSpan = 3;
            actSummaryCell.innerHTML = 'ACT III<br>2-3 clues<br>(Final pieces)<br><span id="act3-count">0</span> added';
        }
        
        // Only add the act summary cell for the first scene of each act
        if (index === 0 || index === 3 || index === 6) {
            row.appendChild(actSummaryCell);
        }

        // Data cells (start from column 3 now since we added act summary)
        for (let i = 2; i < columnCount; i++) {
            const dataCell = document.createElement('td');
            dataCell.className = 'data-cell';
            dataCell.setAttribute('data-column', i);
            dataCell.innerHTML = '<button class="add-item-btn" onclick="addTextItem(this)">+</button>';
            row.appendChild(dataCell);
        }

        tbody.appendChild(row);
    });

    logDebug('Rebuilt default table with 9 scenes and act summaries');
}

        function rebuildTableFromData(tableData) {
    const table = document.getElementById('outlineTable');
    const tbody = table.querySelector('tbody');
    
    // Safety check for invalid data structure
    if (!tableData || !tableData.rows || !Array.isArray(tableData.rows)) {
        logDebug('Invalid table data structure - using default table');
        rebuildDefaultTable();
        return;
    }
    
    // Clear existing rows
    tbody.innerHTML = '';

    // Rebuild rows from data
    tableData.rows.forEach((rowData, index) => {
        // Safety check for each row
        if (!rowData || !rowData.scene) {
            logDebug('Invalid row data - skipping row ' + index);
            return;
        }

        // ADD THIS DEBUGGING
logDebug('Rebuilding row ' + index + ': columns = ' + JSON.stringify(rowData.columns));
logDebug('Columns type: ' + typeof rowData.columns);
logDebug('Columns is array: ' + Array.isArray(rowData.columns));

logDebug('Processing row ' + index + ': ' + rowData.scene + ', columns: ' + (rowData.columns ? rowData.columns.length : 'undefined'));

        const row = document.createElement('tr');
        row.className = rowData.actClass || 'act2';
        
        // Scene cell
        const sceneCell = document.createElement('td');
        sceneCell.className = 'scene-cell';
        sceneCell.contentEditable = true;
        sceneCell.innerHTML = `${rowData.scene}<button class="scene-delete-btn" onclick="deleteRow(this)">×</button>`;
        row.appendChild(sceneCell);

        // Act summary cell (only for first scene of each act)
        if (index === 0) { // Act 1 - first scene
            const actSummaryCell = document.createElement('td');
            actSummaryCell.className = 'act-summary-cell act1-summary';
            actSummaryCell.rowSpan = 3;
            actSummaryCell.innerHTML = 'ACT I<br>4-5 clues<br>(To establish mystery)<br><span id="act1-count">0</span> added';
            row.appendChild(actSummaryCell);
        } else if (index === 3) { // Act 2 - first scene
            const actSummaryCell = document.createElement('td');
            actSummaryCell.className = 'act-summary-cell act2-summary';
            actSummaryCell.rowSpan = 3;
            actSummaryCell.innerHTML = 'ACT II<br>7-10 clues<br>(To build complexity)<br><span id="act2-count">0</span> added';
            row.appendChild(actSummaryCell);
        } else if (index === 6) { // Act 3 - first scene
            const actSummaryCell = document.createElement('td');
            actSummaryCell.className = 'act-summary-cell act3-summary';
            actSummaryCell.rowSpan = 3;
            actSummaryCell.innerHTML = 'ACT III<br>2-3 clues<br>(Final pieces)<br><span id="act3-count">0</span> added';
            row.appendChild(actSummaryCell);
        }

        // Data cells - HANDLE BOTH ARRAY AND OBJECT FORMATS
let columns = rowData.columns || [];

// Convert object format back to array (Firebase converts sparse arrays to objects)
if (columns && typeof columns === 'object' && !Array.isArray(columns)) {
    logDebug('Converting object columns back to array for row ' + index);
    const arrayColumns = [];
    for (let i = 0; i < 8; i++) {
        arrayColumns[i] = columns[i.toString()] || [];
    }
    columns = arrayColumns;
}

const totalHeaders = document.querySelectorAll('#outlineTable thead th').length;
const expectedDataColumns = totalHeaders - 2; // Subtract scenes and act summary columns
        
        logDebug('Row ' + index + ' - Expected data columns: ' + expectedDataColumns + ', saved columns: ' + columns.length);
        
        for (let i = 0; i < expectedDataColumns; i++) {
            const dataCell = document.createElement('td');
            dataCell.className = 'data-cell';
            dataCell.setAttribute('data-column', i + 2); // Start from column 2
            
            // Add text items if they exist in saved data
            if (i < columns.length && Array.isArray(columns[i])) {
                columns[i].forEach(itemData => {
                    if (itemData && itemData.content) {
                        addTextItemWithData(dataCell, itemData.content, itemData.type, i + 2);
                    }
                });
            }

            // Add the + button
            const addButton = document.createElement('button');
            addButton.className = 'add-item-btn';
            addButton.textContent = '+';
            addButton.onclick = function() { addTextItem(this); };
            dataCell.appendChild(addButton);

            row.appendChild(dataCell);
        }

        logDebug('Row ' + index + ' created with ' + row.children.length + ' total cells');
        tbody.appendChild(row);
    });

    setupTableEventListeners();
    updateAllCounts();
    logDebug('Table rebuilt from structured data');
}

        function addTextItemWithData(cell, content, type, columnIndex) {
            const textItem = document.createElement('div');
            textItem.className = 'text-item';
            
            if (type) {
                textItem.classList.add('type-' + type);
            }

            const options = getOptionsForColumn(columnIndex);

            if (options.length > 1) {
                const optionsHtml = options.map(opt => 
                    `<option value="${opt.value}" ${opt.value === type ? 'selected' : ''}>${opt.text}</option>`
                ).join('');
                
                textItem.innerHTML = `
                    <textarea class="item-content" placeholder="Enter your item...">${content}</textarea>
                    <div class="item-controls">
                        <select class="type-select" onchange="updateItemType(this)">
                            ${optionsHtml}
                        </select>
                        <button class="delete-item-btn" onclick="deleteTextItem(this)">×</button>
                    </div>
                `;
            } else {
                textItem.innerHTML = `
                    <textarea class="item-content" placeholder="Enter your item...">${content}</textarea>
                    <div class="item-controls">
                        <button class="delete-item-btn" onclick="deleteTextItem(this)">×</button>
                    </div>
                `;
            }

            const addButton = cell.querySelector('.add-item-btn');
    cell.insertBefore(textItem, addButton);
        }

        function getOptionsForColumn(columnIndex) {
    switch (columnIndex) {
        case 4: // Major Red Herrings/Misdirection (was 5)
            return [
                { value: 'false-suspect', text: 'False Suspect' },
                { value: 'misleading-motivation', text: 'Misleading Motivation' },
                { value: 'wrong-interpretation', text: 'Wrong Interpretation of Evidence' }
            ];
        case 5: // Minor Misdirection (was 6)
            return [
                { value: 'misleading-dialogue', text: 'Misleading Dialogue' },
                { value: 'coincidence', text: 'Coincidence that Suggests Wrong Conclusion' },
                { value: 'character-behavior', text: 'Character Behavior that Implies False Things' }
            ];
        case 6: // Major Contradictions/Inconsistencies (was 7)
            return [
                { value: 'memory-error', text: 'Memory "Error" about Key Events' },
                { value: 'relationship-lie', text: 'Lie about Relationships/Past' },
                { value: 'misperception', text: 'Misperception about Current Events' }
            ];
        case 7: // Minor Inconsistencies (was 8)
            return [
                { value: 'timeline-error', text: 'Small Timeline Error' },
                { value: 'emotional-contradiction', text: 'Emotional Contradiction' },
                { value: 'detail-inconsistency', text: 'Details that Don\'t Add Up' }
            ];
        case 8: // Major Twist/Revelation (was 9)
            return [
                { value: 'major-revelation', text: 'Major Twist/Revelation' }
            ];
        case 9: // Minor Revelations/Other Information (was 10)
            return [
                { value: 'character-backstory', text: 'Character Backstory Reveal' },
                { value: 'relationship-truth', text: 'Relationship Truth' },
                { value: 'small-mystery', text: 'Small Mystery Solution' }
            ];
        default:
            return [];
    }
}

        // Table manipulation functions
        function addTextItem(button) {
    const cell = button.parentNode;
    const columnIndex = parseInt(cell.dataset.column);
    const textItem = document.createElement('div');
    textItem.className = 'text-item';

    const options = getOptionsForColumn(columnIndex);

    if (options.length > 1) {
        textItem.innerHTML = `
            <textarea class="item-content" placeholder="Enter your item..."></textarea>
            <div class="item-controls">
                <select class="type-select" onchange="updateItemType(this)">
                    ${options.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                </select>
                <button class="delete-item-btn" onclick="deleteTextItem(this)">×</button>
            </div>
        `;
    } else {
        textItem.innerHTML = `
            <textarea class="item-content" placeholder="Enter your item..."></textarea>
            <div class="item-controls">
                <button class="delete-item-btn" onclick="deleteTextItem(this)">×</button>
            </div>
        `;
    }

    cell.insertBefore(textItem, button);
    
    updateAllCounts();
    scheduleAutoSave();
    
    logDebug('Added text item to column ' + columnIndex);
}

        function deleteTextItem(button) {
            const textItem = button.closest('.text-item');
            textItem.remove();
            updateAllCounts();
            scheduleAutoSave();
            
            logDebug('Deleted text item');
        }

        function forceSave() {
    if (!currentUser) {
        alert('Not logged in - cannot save');
        return;
    }
    
    logDebug('Manual save triggered');
    saveData();
}

        function exportDataToText() {
    const data = {
        title: document.getElementById('bookTitle').value,
        tableData: extractTableData(),
        exportDate: new Date().toISOString()
    };
    
    const jsonText = JSON.stringify(data, null, 2);
    
    // Create a popup window with the JSON text
    const popup = window.open('', 'backup', 'width=600,height=400,scrollbars=yes');
    popup.document.write(`
        <html>
        <head><title>Thriller Outline Backup</title></head>
        <body>
            <h3>Copy this text and save as a .json file:</h3>
            <textarea style="width:100%; height:300px; font-family:monospace;">${jsonText}</textarea>
            <p>Select all text above (Ctrl+A), copy (Ctrl+C), then paste into a text file and save with .json extension</p>
        </body>
        </html>
    `);
}

        function updateItemType(select) {
            const textItem = select.closest('.text-item');
            
            // Remove all type classes
            const typeClasses = [
                'type-false-suspect', 'type-misleading-motivation', 'type-wrong-interpretation',
                'type-misleading-dialogue', 'type-coincidence', 'type-character-behavior',
                'type-major-revelation', 'type-character-backstory', 'type-relationship-truth',
                'type-small-mystery', 'type-memory-error', 'type-relationship-lie',
                'type-misperception', 'type-timeline-error', 'type-emotional-contradiction',
                'type-detail-inconsistency'
            ];
            
            typeClasses.forEach(cls => textItem.classList.remove(cls));
            
            // Add new type class
            textItem.classList.add('type-' + select.value);
            scheduleAutoSave();
            
            logDebug('Updated item type to: ' + select.value);
        }

        function addColumn() {
            const table = document.getElementById('outlineTable');
            const headerRow = table.querySelector('thead tr');
            const bodyRows = table.querySelectorAll('tbody tr:not(.count-row)');
            
            // Add header
            const newHeader = document.createElement('th');
            newHeader.className = 'column-header';
            newHeader.innerHTML = `
                New Column
                <div class="header-controls">
                    <button class="header-btn" onclick="editColumnHeader(this)">✎</button>
                    <button class="header-btn" onclick="deleteColumn(this)">✗</button>
                </div>
            `;
            headerRow.appendChild(newHeader);
            
            // Add cells to existing rows
            const newColumnIndex = headerRow.children.length - 1;
            bodyRows.forEach(row => {
                const newCell = document.createElement('td');
                newCell.className = 'data-cell';
                newCell.setAttribute('data-column', newColumnIndex);
                newCell.innerHTML = '<button class="add-item-btn" onclick="addTextItem(this)">+</button>';
                row.appendChild(newCell);
            });
            
            scheduleAutoSave();
            logDebug('Added new column');
        }

        function deleteColumn(button) {
            if (!confirm('Are you sure you want to delete this column?')) return;
            
            const header = button.closest('th');
            const columnIndex = Array.from(header.parentNode.children).indexOf(header);
            
            if (columnIndex === 0) {
                alert('Cannot delete the scenes column');
                return;
            }
            
            // Remove header
            header.remove();
            
            // Remove corresponding cells
            const table = document.getElementById('outlineTable');
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                if (row.children[columnIndex]) {
                    row.children[columnIndex].remove();
                }
            });
            
            updateAllCounts();
            scheduleAutoSave();
            logDebug('Deleted column ' + columnIndex);
        }

        function addScene() {
            const table = document.getElementById('outlineTable').querySelector('tbody');
            const columnCount = document.querySelectorAll('thead th').length;
            const sceneCount = table.querySelectorAll('tr:not(.count-row)').length + 1;
            
            const newRow = document.createElement('tr');
            newRow.className = 'act2'; // Default to act 2
            
            // Scene cell
            const sceneCell = document.createElement('td');
            sceneCell.className = 'scene-cell';
            sceneCell.contentEditable = true;
            sceneCell.innerHTML = `
                Scene ${sceneCount} - New Scene
                <button class="scene-delete-btn" onclick="deleteRow(this)">×</button>
            `;
            newRow.appendChild(sceneCell);
            
            // Data cells
            for (let i = 1; i < columnCount; i++) {
                const dataCell = document.createElement('td');
                dataCell.className = 'data-cell';
                dataCell.setAttribute('data-column', i);
                dataCell.innerHTML = '<button class="add-item-btn" onclick="addTextItem(this)">+</button>';
                newRow.appendChild(dataCell);
            }
            
            // Insert before count row if it exists
            const countRow = table.querySelector('.count-row');
            if (countRow) {
                table.insertBefore(newRow, countRow);
            } else {
                table.appendChild(newRow);
            }
            
            scheduleAutoSave();
            logDebug('Added new scene');
        }

        function deleteRow(button) {
            if (!confirm('Are you sure you want to delete this scene?')) return;
            
            const row = button.closest('tr');
            row.remove();
            updateAllCounts();
            scheduleAutoSave();
            logDebug('Deleted scene row');
        }

        function editColumnHeader(button) {
            const header = button.closest('th');
            const currentText = header.firstChild.textContent.trim();
            const newText = prompt('Edit column header:', currentText);
            
            if (newText && newText !== currentText) {
                header.firstChild.textContent = newText;
                scheduleAutoSave();
                logDebug('Edited column header: ' + newText);
            }
        }

        function updateAllCounts() {
    const table = document.getElementById('outlineTable');
    const headers = table.querySelectorAll('thead th');
    
    // Remove existing count row
    const existingCountRow = table.querySelector('.count-row');
    if (existingCountRow) {
        existingCountRow.remove();
    }
    
    // Create new count row
    const countRow = document.createElement('tr');
    countRow.className = 'count-row';
    
    // Count items by act for the act summary
    let act1Count = 0, act2Count = 0, act3Count = 0;
    
    headers.forEach((header, index) => {
        const countCell = document.createElement('td');
        countCell.className = 'count-cell';
        
        if (index === 0) {
            countCell.textContent = 'TOTALS:';
        } else if (index === 1) {
            countCell.textContent = 'BY ACT';
        } else {
            const columnCells = table.querySelectorAll(`td[data-column="${index}"]`);
            let count = 0;
            
            columnCells.forEach(cell => {
                const itemCount = cell.querySelectorAll('.text-item').length;
                count += itemCount;
            });
            
            countCell.textContent = count;
        }
        
        countRow.appendChild(countCell);
    });
    
    // Separately count clues for act summaries
    // Count from data-column 2 (Obvious), 3 (Subtle), and 4 (Major Red Herrings)
    const clueColumns = [2, 3, 4]; // The data-column values for clue-related columns
    
    clueColumns.forEach(columnNum => {
        const columnCells = table.querySelectorAll(`td[data-column="${columnNum}"]`);
        columnCells.forEach(cell => {
            const itemCount = cell.querySelectorAll('.text-item').length;
            const row = cell.closest('tr');
            
            if (row.classList.contains('act1')) {
                act1Count += itemCount;
            } else if (row.classList.contains('act2')) {
                act2Count += itemCount;
            } else if (row.classList.contains('act3')) {
                act3Count += itemCount;
            }
        });
    });
    
    table.querySelector('tbody').appendChild(countRow);
    
    // Update act summary counts
    const act1Span = document.getElementById('act1-count');
    const act2Span = document.getElementById('act2-count');
    const act3Span = document.getElementById('act3-count');
    
    if (act1Span) act1Span.textContent = act1Count;
    if (act2Span) act2Span.textContent = act2Count;
    if (act3Span) act3Span.textContent = act3Count;
}

        function setupTableEventListeners() {
    // Auto-save on content changes
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('item-content')) {
            scheduleAutoSave();
        } else if (e.target.id === 'bookTitle' || 
                   e.target.classList.contains('scene-cell')) {
            scheduleAutoSave();
        }
    });
    
    updateAllCounts();
    logDebug('Table event listeners set up');
}

        function exportData() {
            const data = {
                title: document.getElementById('bookTitle').value,
                tableData: extractTableData(),
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'thriller-outline-' + new Date().toISOString().slice(0,10) + '.json';
            link.click();
            URL.revokeObjectURL(url);
            
            logDebug('Data exported');
        }

        function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            // Set title
            document.getElementById('bookTitle').value = data.title || 'Imported Thriller';
            
            // Try to rebuild table, with fallback
            if (data.tableData) {
                try {
                    rebuildTableFromData(data.tableData);
                    logDebug('Data imported successfully');
                } catch (error) {
                    logDebug('Error rebuilding from imported data: ' + error.message);
                    rebuildDefaultTable();
                    alert('Imported data structure was incompatible. Created default table instead.');
                }
                scheduleAutoSave();
            }
        } catch (error) {
            alert('Error importing file: ' + error.message);
            logDebug('Import error: ' + error.message);
        }
    };
    reader.readAsText(file);
}

        // Auth state listener
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('userInitial').textContent = user.email.charAt(0).toUpperCase();
                document.getElementById('displayName').textContent = user.email;
                logDebug('User logged in: ' + user.email);
                showApp();
                loadData();
            } else {
                currentUser = null;
                logDebug('User logged out');
                showAuth();
                hideLoading();
            }
        });

        // Event listeners
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Enter key listeners for auth
        emailInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });
        passwordInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('DOM loaded - initializing app');
            
            // Ensure the table has all 9 scenes on initial load
            ensureFullTable();
            
            // Auto-save every 30 seconds if we have a user (real or anonymous)
            setInterval(() => {
                if (currentUser && document.getElementById('bookTitle').value.trim()) {
                    logDebug('Periodic auto-save triggered');
                    saveData();
                }
            }, 30000);
        });
        // Title ideas functions
let draggedElement = null;

function addTitleIdea() {
    const list = document.getElementById('titleIdeasList');
    const titleItem = createTitleItem('', list.children.length + 1);
    list.appendChild(titleItem);
    
    // Focus the new input
    const input = titleItem.querySelector('.title-idea-text');
    input.focus();
    
    updateRankNumbers();
    saveTitleIdeas();
}

function createTitleItem(title, rank) {
    const titleItem = document.createElement('div');
    titleItem.className = 'title-idea-item';
    titleItem.draggable = true;
    
    titleItem.innerHTML = `
        <span class="drag-handle">⋮⋮</span>
        <span class="title-rank">${rank}</span>
        <input type="text" class="title-idea-text" value="${title}" placeholder="Enter title idea..." oninput="saveTitleIdeas()">
        <button class="delete-title-btn" onclick="deleteTitleIdea(this)">×</button>
    `;
    
    // Add drag event listeners
    titleItem.addEventListener('dragstart', handleDragStart);
    titleItem.addEventListener('dragover', handleDragOver);
    titleItem.addEventListener('drop', handleDrop);
    titleItem.addEventListener('dragend', handleDragEnd);
    
    return titleItem;
}

function deleteTitleIdea(button) {
    const titleItem = button.closest('.title-idea-item');
    titleItem.remove();
    updateRankNumbers();
    saveTitleIdeas();
}

function updateRankNumbers() {
    const items = document.querySelectorAll('.title-idea-item');
    items.forEach((item, index) => {
        const rankSpan = item.querySelector('.title-rank');
        rankSpan.textContent = index + 1;
    });
}

function handleDragStart(e) {
    draggedElement = e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    if (e.target.closest('.title-idea-item') && e.target.closest('.title-idea-item') !== draggedElement) {
        const rect = e.target.closest('.title-idea-item').getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        // Remove existing indicators
        document.querySelectorAll('.drop-indicator').forEach(indicator => {
            indicator.classList.remove('active');
        });
        
        // Show drop indicator
        const targetItem = e.target.closest('.title-idea-item');
        if (e.clientY < midY) {
            // Insert before
            insertDropIndicator(targetItem, 'before');
        } else {
            // Insert after
            insertDropIndicator(targetItem, 'after');
        }
    }
}

function handleDrop(e) {
    e.preventDefault();
    
    if (e.target.closest('.title-idea-item') && e.target.closest('.title-idea-item') !== draggedElement) {
        const targetItem = e.target.closest('.title-idea-item');
        const rect = targetItem.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        
        if (e.clientY < midY) {
            // Insert before target
            targetItem.parentNode.insertBefore(draggedElement, targetItem);
        } else {
            // Insert after target
            targetItem.parentNode.insertBefore(draggedElement, targetItem.nextSibling);
        }
        
        updateRankNumbers();
        saveTitleIdeas();
    }
    
    // Clean up indicators
    document.querySelectorAll('.drop-indicator').forEach(indicator => {
        indicator.remove();
    });
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    draggedElement = null;
    
    // Clean up indicators
    document.querySelectorAll('.drop-indicator').forEach(indicator => {
        indicator.remove();
    });
}

function insertDropIndicator(targetItem, position) {
    const indicator = document.createElement('div');
    indicator.className = 'drop-indicator active';
    
    if (position === 'before') {
        targetItem.parentNode.insertBefore(indicator, targetItem);
    } else {
        targetItem.parentNode.insertBefore(indicator, targetItem.nextSibling);
    }
}

function saveTitleIdeas() {
    if (!currentUser) return;
    
    const titleInputs = document.querySelectorAll('.title-idea-text');
    const titles = Array.from(titleInputs).map(input => input.value.trim()).filter(title => title !== '');
    
    firebase.database().ref(`thriller-outlines/${currentUser.uid}/titleIdeas`).set(titles)
        .then(() => {
            logDebug('Title ideas saved: ' + titles.length + ' titles');
        })
        .catch(error => {
            logDebug('Error saving title ideas: ' + error.message);
        });
}

function loadTitleIdeas(titleIdeas) {
    const list = document.getElementById('titleIdeasList');
    list.innerHTML = '';
    
    if (titleIdeas && titleIdeas.length > 0) {
        titleIdeas.forEach((title, index) => {
            const titleItem = createTitleItem(title, index + 1);
            list.appendChild(titleItem);
        });
        logDebug('Loaded ' + titleIdeas.length + ' title ideas');
    }
}
    </script>
</body>
</html>
